<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Ferme BUHUMUZA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        * {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="./js/data.js"></script>
    <script src="./js/icons.js"></script>
    <script src="./js/utils.js"></script>
    <script>
        // EmailJS Configuration
        // TODO: Replace these with your actual EmailJS credentials after setup (created by muhozapilote799@gmail.com - account)
        const EMAILJS_PUBLIC_KEY = '3Tif8ul3xP0GKGkp8'; // Get from EmailJS dashboard
        const EMAILJS_SERVICE_ID = 'service_cz5w5rl';
        const EMAILJS_TEMPLATE_ID = 'template_64vxong';

        // Notification settings (stored in localStorage)
        let notificationSettings = {
            email: '',
            phone: '',
            pregnancyWarningDays: 7,  // Alert 7 days before delivery
            vaccinationWarningDays: 7, // Alert 7 days before vaccination
            enablePregnancyAlerts: true,
            enableVaccinationAlerts: true
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('farmNotificationSettings');
            if (saved) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(saved) };
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('farmNotificationSettings', JSON.stringify(notificationSettings));
        }

        // Calculate days until delivery
        function getDaysUntilDelivery(estimatedDelivery) {
            const today = new Date();
            const deliveryDate = new Date(estimatedDelivery);
            return Math.floor((deliveryDate - today) / (1000 * 60 * 60 * 24));
        }

        // Calculate days until next vaccination
        function getDaysUntilNextVaccination(lastVaccinationDate) {
            const today = new Date();
            const lastDate = new Date(lastVaccinationDate);
            const nextDate = new Date(lastDate);
            nextDate.setMonth(nextDate.getMonth() + 3); // 3 months from last vaccination
            return Math.floor((nextDate - today) / (1000 * 60 * 60 * 24));
        }

        // Get pregnancy alerts
        function getPregnancyAlerts() {
            const alerts = [];
            
            cows.forEach(cow => {
                if (!cow.reproductiveHistory) return;
                
                const activePregnancy = cow.reproductiveHistory.find(
                    event => event.type === 'pregnancy' && event.status === 'active'
                );
                
                if (activePregnancy) {
                    const daysLeft = getDaysUntilDelivery(activePregnancy.estimatedDelivery);
                    
                    if (daysLeft <= notificationSettings.pregnancyWarningDays && daysLeft >= 0) {
                        alerts.push({
                            type: 'pregnancy',
                            cow: cow,
                            daysLeft: daysLeft,
                            pregnancyDate: activePregnancy.pregnancyDate,
                            estimatedDelivery: activePregnancy.estimatedDelivery,
                            urgent: daysLeft <= 2
                        });
                    }
                }
            });
            
            return alerts;
        }

        // Get vaccination alerts
        function getVaccinationAlerts() {
            const alerts = [];
            
            cows.forEach(cow => {
                if (!cow.vaccinations || cow.vaccinations.length === 0) return;
                
                // Get most recent vaccination
                const sortedVaccinations = [...cow.vaccinations].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                const lastVaccination = sortedVaccinations[0];
                
                const daysUntilNext = getDaysUntilNextVaccination(lastVaccination.date);
                
                if (daysUntilNext <= notificationSettings.vaccinationWarningDays && daysUntilNext >= -7) {
                    const nextDate = new Date(lastVaccination.date);
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    
                    alerts.push({
                        type: 'vaccination',
                        cow: cow,
                        daysUntilNext: daysUntilNext,
                        lastDate: lastVaccination.date,
                        lastVaccine: lastVaccination.vaccine,
                        nextDate: nextDate.toISOString().split('T')[0],
                        overdue: daysUntilNext < 0,
                        urgent: Math.abs(daysUntilNext) <= 2
                    });
                }
            });
            
            return alerts;
        }

        // Send email notification
        async function sendEmailNotification(alert) {
            if (!notificationSettings.email) {
                alert('Veuillez configurer votre adresse email dans les param√®tres.');
                return false;
            }

            // Check if EmailJS is configured
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                alert('EmailJS n\'est pas encore configur√©. Consultez le guide de configuration.');
                return false;
            }

            try {
                // Initialize EmailJS
                emailjs.init(EMAILJS_PUBLIC_KEY);

                let message = '';
                let subject = '';

                if (alert.type === 'pregnancy') {
                    subject = `üêÑ Alerte: ${alert.cow.name} - Accouchement dans ${alert.daysLeft} jours`;
                    message = `
Bonjour,

Ceci est une alerte automatique de la Ferme BUHUMUZA.

üêÑ Vache: ${alert.cow.name}
üè∑Ô∏è √âtiquette: ${alert.cow.tagNumber}
üë§ Propri√©taire: ${alert.cow.owner}

ü§∞ ALERTE DE GROSSESSE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ Date de grossesse: ${formatDate(alert.pregnancyDate)}
üìÖ Date d'accouchement pr√©vue: ${formatDate(alert.estimatedDelivery)}
‚è∞ Jours restants: ${alert.daysLeft} jour${alert.daysLeft > 1 ? 's' : ''}

${alert.urgent ? 'üö® URGENT: Accouchement imminent!' : ''}

Merci de pr√©parer l'accouchement.

---
Syst√®me de Gestion - Ferme BUHUMUZA
                    `;
                } else if (alert.type === 'vaccination') {
                    subject = `üíâ Alerte: ${alert.cow.name} - ${alert.overdue ? 'Vaccination EN RETARD' : `Vaccination dans ${alert.daysUntilNext} jours`}`;
                    message = `
Bonjour,

Ceci est une alerte automatique de la Ferme BUHUMUZA.

üêÑ Vache: ${alert.cow.name}
üè∑Ô∏è √âtiquette: ${alert.cow.tagNumber}
üë§ Propri√©taire: ${alert.cow.owner}

üíâ ALERTE DE VACCINATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ Derni√®re vaccination: ${formatDate(alert.lastDate)}
üíä Vaccin pr√©c√©dent: ${alert.lastVaccine}
üìÖ Prochaine vaccination: ${formatDate(alert.nextDate)}
‚è∞ ${alert.overdue ? `EN RETARD de ${Math.abs(alert.daysUntilNext)} jour${Math.abs(alert.daysUntilNext) > 1 ? 's' : ''}` : `Dans ${alert.daysUntilNext} jour${alert.daysUntilNext > 1 ? 's' : ''}`}

${alert.urgent || alert.overdue ? 'üö® URGENT: Vaccination n√©cessaire!' : ''}

Rappel: Les vaches doivent √™tre vaccin√©es tous les 3 mois.

---
Syst√®me de Gestion - Ferme BUHUMUZA
                    `;
                }

                // Send email via EmailJS
                const response = await emailjs.send(
                    EMAILJS_SERVICE_ID,
                    EMAILJS_TEMPLATE_ID,
                    {
                        to_email: notificationSettings.email,
                        subject: subject,
                        message: message,
                        cow_name: alert.cow.name
                    }
                );

                console.log('Email sent successfully:', response);
                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                alert('Erreur lors de l\'envoi de l\'email: ' + error.text);
                return false;
            }
        }

        // Send all pending notifications
        async function sendAllNotifications() {
            const pregnancyAlerts = notificationSettings.enablePregnancyAlerts ? getPregnancyAlerts() : [];
            const vaccinationAlerts = notificationSettings.enableVaccinationAlerts ? getVaccinationAlerts() : [];
            
            const allAlerts = [...pregnancyAlerts, ...vaccinationAlerts];
            
            if (allAlerts.length === 0) {
                alert('Aucune notification √† envoyer pour le moment.');
                return;
            }

            const confirmed = confirm(`Envoyer ${allAlerts.length} notification(s) √† ${notificationSettings.email}?`);
            if (!confirmed) return;

            let sent = 0;
            for (const alert of allAlerts) {
                const success = await sendEmailNotification(alert);
                if (success) sent++;
                // Wait 1 second between emails to avoid rate limits
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            alert(`${sent} notification(s) envoy√©e(s) avec succ√®s!`);
            renderApp();
        }

        // Update settings
        function updateSettings() {
            notificationSettings.email = document.getElementById('email').value;
            notificationSettings.phone = document.getElementById('phone').value;
            notificationSettings.pregnancyWarningDays = parseInt(document.getElementById('pregnancyDays').value);
            notificationSettings.vaccinationWarningDays = parseInt(document.getElementById('vaccinationDays').value);
            notificationSettings.enablePregnancyAlerts = document.getElementById('enablePregnancy').checked;
            notificationSettings.enableVaccinationAlerts = document.getElementById('enableVaccination').checked;
            
            saveSettings();
            alert('Param√®tres sauvegard√©s!');
            renderApp();
        }

        function renderApp() {
            loadSettings();
            const pregnancyAlerts = notificationSettings.enablePregnancyAlerts ? getPregnancyAlerts() : [];
            const vaccinationAlerts = notificationSettings.enableVaccinationAlerts ? getVaccinationAlerts() : [];
            const totalAlerts = pregnancyAlerts.length + vaccinationAlerts.length;

            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 flex flex-col">
                    <!-- Header -->
                    <div class="bg-white shadow-md sticky top-0 z-50">
                        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div class="flex items-center justify-between">
                                <a href="index.html" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors font-medium">
                                    ${icons.arrowLeft(20, 'mr-2')}
                                    <span class="text-sm sm:text-base">Retour</span>
                                </a>
                                <h1 class="text-lg sm:text-xl font-bold text-gray-800">Notifications</h1>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 w-full">
                        
                        <!-- Alert Banner -->
                        ${totalAlerts > 0 ? `
                            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl p-6 mb-6 shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-2xl font-bold mb-2">üîî ${totalAlerts} Alerte${totalAlerts > 1 ? 's' : ''} Active${totalAlerts > 1 ? 's' : ''}</h2>
                                        <p class="text-white/90">Des notifications n√©cessitent votre attention</p>
                                    </div>
                                    <button onclick="sendAllNotifications();" class="bg-white text-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-50 transition-all">
                                        Envoyer tout
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl p-6 mb-6 shadow-lg">
                                <div class="flex items-center">
                                    <div class="text-4xl mr-4">‚úÖ</div>
                                    <div>
                                        <h2 class="text-2xl font-bold mb-1">Aucune alerte</h2>
                                        <p class="text-white/90">Toutes les vaches sont √† jour</p>
                                    </div>
                                </div>
                            </div>
                        `}

                        <!-- Settings Card -->
                        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Param√®tres de Notification</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üìß Adresse Email *</label>
                                    <input id="email" type="email" value="${notificationSettings.email}" placeholder="votre@email.com" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üì± T√©l√©phone (optionnel)</label>
                                    <input id="phone" type="tel" value="${notificationSettings.phone}" placeholder="+257 XX XXX XXX" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ü§∞ Alertes Grossesse (jours avant)</label>
                                        <input id="pregnancyDays" type="number" min="1" max="30" value="${notificationSettings.pregnancyWarningDays}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üíâ Alertes Vaccination (jours avant)</label>
                                        <input id="vaccinationDays" type="number" min="1" max="30" value="${notificationSettings.vaccinationWarningDays}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input id="enablePregnancy" type="checkbox" ${notificationSettings.enablePregnancyAlerts ? 'checked' : ''} class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500">
                                        <span class="ml-3 text-gray-700">Activer les alertes de grossesse</span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input id="enableVaccination" type="checkbox" ${notificationSettings.enableVaccinationAlerts ? 'checked' : ''} class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500">
                                        <span class="ml-3 text-gray-700">Activer les alertes de vaccination</span>
                                    </label>
                                </div>

                                <button onclick="updateSettings();" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                                    üíæ Sauvegarder les Param√®tres
                                </button>
                            </div>
                        </div>

                        <!-- Pregnancy Alerts -->
                        ${pregnancyAlerts.length > 0 ? `
                            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">ü§∞ Alertes de Grossesse (${pregnancyAlerts.length})</h2>
                                <div class="space-y-4">
                                    ${pregnancyAlerts.map(alert => `
                                        <div class="border-2 ${alert.urgent ? 'border-red-400 bg-red-50' : 'border-pink-200 bg-pink-50'} rounded-xl p-4 sm:p-6">
                                            <div class="flex items-start justify-between mb-3">
                                                <div>
                                                    <h3 class="font-bold text-lg text-gray-800">${alert.cow.name}</h3>
                                                    <p class="text-sm text-gray-600">${alert.cow.tagNumber} ‚Ä¢ ${alert.cow.owner}</p>
                                                </div>
                                                ${alert.urgent ? '<span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">URGENT</span>' : ''}
                                            </div>
                                            <div class="space-y-2 text-sm">
                                                <p><span class="font-medium">Date de grossesse:</span> ${formatDate(alert.pregnancyDate)}</p>
                                                <p><span class="font-medium">Accouchement pr√©vu:</span> ${formatDate(alert.estimatedDelivery)}</p>
                                                <p class="text-pink-700 font-bold text-base">‚è∞ Dans ${alert.daysLeft} jour${alert.daysLeft > 1 ? 's' : ''}</p>
                                            </div>
                                            <button onclick="sendEmailNotification(${JSON.stringify(alert).replace(/"/g, '&quot;')});" class="mt-4 w-full bg-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-pink-600 transition-all">
                                                üìß Envoyer notification
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Vaccination Alerts -->
                        ${vaccinationAlerts.length > 0 ? `
                            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üíâ Alertes de Vaccination (${vaccinationAlerts.length})</h2>
                                <div class="space-y-4">
                                    ${vaccinationAlerts.map(alert => `
                                        <div class="border-2 ${alert.overdue ? 'border-red-400 bg-red-50' : alert.urgent ? 'border-orange-300 bg-orange-50' : 'border-blue-200 bg-blue-50'} rounded-xl p-4 sm:p-6">
                                            <div class="flex items-start justify-between mb-3">
                                                <div>
                                                    <h3 class="font-bold text-lg text-gray-800">${alert.cow.name}</h3>
                                                    <p class="text-sm text-gray-600">${alert.cow.tagNumber} ‚Ä¢ ${alert.cow.owner}</p>
                                                </div>
                                                ${alert.overdue ? '<span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">EN RETARD</span>' : alert.urgent ? '<span class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold">URGENT</span>' : ''}
                                            </div>
                                            <div class="space-y-2 text-sm">
                                                <p><span class="font-medium">Derni√®re vaccination:</span> ${formatDate(alert.lastDate)}</p>
                                                <p><span class="font-medium">Vaccin:</span> ${alert.lastVaccine}</p>
                                                <p><span class="font-medium">Prochaine vaccination:</span> ${formatDate(alert.nextDate)}</p>
                                                <p class="${alert.overdue ? 'text-red-700' : 'text-blue-700'} font-bold text-base">
                                                    ‚è∞ ${alert.overdue ? `EN RETARD de ${Math.abs(alert.daysUntilNext)} jour${Math.abs(alert.daysUntilNext) > 1 ? 's' : ''}` : `Dans ${alert.daysUntilNext} jour${alert.daysUntilNext > 1 ? 's' : ''}`}
                                                </p>
                                            </div>
                                            <button onclick="sendEmailNotification(${JSON.stringify(alert).replace(/"/g, '&quot;')});" class="mt-4 w-full bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-all">
                                                üìß Envoyer notification
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Setup Guide -->
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-6 sm:p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìñ Guide de Configuration EmailJS</h2>
                            <div class="space-y-3 text-sm text-gray-700">
                                <p class="font-semibold">Pour activer les notifications par email:</p>
                                <ol class="list-decimal ml-6 space-y-2">
                                    <li>Cr√©ez un compte gratuit sur <a href="https://www.emailjs.com" target="_blank" class="text-blue-600 underline">EmailJS.com</a></li>
                                    <li>Ajoutez un service email (Gmail, Outlook, etc.)</li>
                                    <li>Cr√©ez un template avec ces variables: <code class="bg-gray-200 px-2 py-1 rounded">to_email, subject, message, cow_name</code></li>
                                    <li>Copiez vos cl√©s (Public Key, Service ID, Template ID)</li>
                                    <li>Modifiez le fichier <code class="bg-gray-200 px-2 py-1 rounded">notifications.html</code> et remplacez les valeurs en haut du script</li>
                                </ol>
                                <p class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 rounded">
                                    <strong>Note:</strong> EmailJS offre 200 emails gratuits par mois, ce qui est largement suffisant pour une ferme.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <footer class="bg-white border-t border-gray-200 mt-8">
                        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <p class="text-center text-gray-600 text-sm">
                                Site web cr√©√© et maintenu par <span class="font-bold text-emerald-600">Pilote Muhoza</span>
                            </p>
                        </div>
                    </footer>
                </div>
            `;
        }

        // Initial render
        renderApp();
    </script>
</body>
</html>